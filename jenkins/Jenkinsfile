pipeline {
    agent {
        kubernetes {
            yamlFile 'jenkins/kaniko/index.yaml'
        }
    }
    
    environment {
        // AWS Configuration
        AWS_REGION       = 'eu-north-1'
        AWS_ACCOUNT_ID   = '428346553093'
        
        // ECR Configuration
        ECR_REPOSITORY   = 'my-app'
        ECR_REGISTRY     = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        
        // EKS Configuration
        EKS_CLUSTER_NAME = 'ITI-GP-Cluster'
        K8S_NAMESPACE    = 'default'
        
        // Application Configuration
        APP_NAME         = 'my-app'
        
        // Image Tags - will be set dynamically in the pipeline
        IMAGE_TAG        = ''
        IMAGE_NAME       = ''
        IMAGE_LATEST     = "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
        
        // Build Configuration
        DOCKERFILE_PATH  = 'node_app/Dockerfile'
        BUILD_CONTEXT    = 'node_app'
    }
    
    stages {
        stage('ğŸ” Checkout & Preparation') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'ğŸ” STAGE 1: Checkout & Preparation'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    
                    checkout scm
                    
                    // Get git commit info
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_COMMIT_MSG = sh(
                        script: "git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()
                    
                    // Get git branch name
                    env.GIT_BRANCH = sh(
                        script: "git rev-parse --abbrev-ref HEAD",
                        returnStdout: true
                    ).trim()
                    
                    // Create unique image tag: build-<BUILD_NUMBER>-<GIT_COMMIT>-<TIMESTAMP>
                    def timestamp = sh(
                        script: "date +%Y%m%d-%H%M%S",
                        returnStdout: true
                    ).trim()
                    
                    // Format: v1.0.0-b123-a1b2c3d-20251112-165430
                    env.IMAGE_TAG = "v1.0.0-b${BUILD_NUMBER}-${env.GIT_COMMIT_SHORT}-${timestamp}"
                    env.IMAGE_NAME = "${ECR_REGISTRY}/${ECR_REPOSITORY}:${env.IMAGE_TAG}"
                    
                    echo "âœ… Repository checked out successfully"
                    echo "ğŸ“ Commit: ${env.GIT_COMMIT_SHORT}"
                    echo "ğŸŒ¿ Branch: ${env.GIT_BRANCH}"
                    echo "ğŸ’¬ Message: ${env.GIT_COMMIT_MSG}"
                    echo "ğŸ·ï¸  Image Tag: ${env.IMAGE_TAG}"
                }
            }
        }
        
        stage('ğŸ“Š Build Information') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'ğŸ“Š STAGE 2: Build Information'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo "ğŸ·ï¸  Build Number: ${BUILD_NUMBER}"
                    echo "ğŸŒ¿ Git Branch: ${env.GIT_BRANCH}"
                    echo "ğŸ“ Git Commit: ${env.GIT_COMMIT_SHORT}"
                    echo "ğŸ’¬ Commit Message: ${env.GIT_COMMIT_MSG}"
                    echo "ğŸ“¦ Image Tag: ${env.IMAGE_TAG}"
                    echo "ğŸ³ Image Name: ${env.IMAGE_NAME}"
                    echo "â˜ï¸  ECR Registry: ${ECR_REGISTRY}"
                    echo "ğŸ¯ EKS Cluster: ${EKS_CLUSTER_NAME}"
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                }
            }
        }
        
        stage('âœ… Environment Verification') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'âœ… STAGE 3: Environment Verification'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    
                    sh '''
                        echo "ğŸ“ Workspace: ${WORKSPACE}"
                        echo ""
                        echo "ğŸ“‚ Workspace structure:"
                        ls -lah ${WORKSPACE}
                        echo ""
                        echo "ğŸ“¦ Application directory (${BUILD_CONTEXT}):"
                        ls -lah ${WORKSPACE}/${BUILD_CONTEXT} || {
                            echo "âŒ ERROR: Application directory not found!"
                            exit 1
                        }
                        echo ""
                        echo "ğŸ³ Dockerfile check:"
                        if [ -f "${WORKSPACE}/${DOCKERFILE_PATH}" ]; then
                            echo "âœ… Dockerfile found at ${DOCKERFILE_PATH}"
                            echo "First 10 lines of Dockerfile:"
                            head -10 ${WORKSPACE}/${DOCKERFILE_PATH}
                        else
                            echo "âŒ ERROR: Dockerfile not found at ${DOCKERFILE_PATH}"
                            exit 1
                        fi
                    '''
                    
                    echo "âœ… Environment verification completed successfully"
                }
            }
        }
        
        stage('ğŸ”§ Debug Pod Identity') {
            steps {
                container('kaniko') {
                    script {
                        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                        echo 'ğŸ”§ STAGE 4: Debug Pod Identity'
                        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                        
                        // Use direct commands instead of sh block
                        try {
                            sh '/busybox/sh -c "echo ğŸ” AWS Authentication Check"'
                            sh '/busybox/sh -c "echo AWS_REGION: $AWS_REGION"'
                            sh '/busybox/sh -c "echo User: $(whoami)"'
                            sh '/busybox/sh -c "ls -la /kaniko/executor && echo âœ… kaniko available || echo âŒ kaniko not found"'
                        } catch (Exception e) {
                            echo "âš ï¸ Debug commands failed: ${e.message}"
                            echo "Continuing with build..."
                        }
                    }
                }
            }
        }
        
        stage('ğŸ”§ Prepare Build Context') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'ğŸ”§ STAGE 5: Prepare Build Context'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo "âœ… Using Jenkins service account with ECR permissions"
                    echo "ğŸ” IAM Role: ${env.JENKINS_ROLE_ARN ?: 'Using default service account role'}"
                    echo "ï¿½ Build Context: ${BUILD_CONTEXT}"
                    echo "ğŸ³ Dockerfile: ${DOCKERFILE_PATH}"
                    echo "âœ… Build context preparation completed"
                }
            }
        }

        stage('ğŸš€ Build & Push with Kaniko') {
            steps {
                container('kaniko') {
                    script {
                        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                        echo 'ğŸš€ STAGE 6: Build & Push Docker Image'
                        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                        
                        sh '''#!/busybox/sh
                            set -e
                            
                            echo "ğŸ” Pre-build verification"
                            echo "AWS_REGION: ${AWS_REGION}"
                            echo "IMAGE_TAG: ${IMAGE_TAG}"
                            echo "IMAGE_NAME: ${IMAGE_NAME}"
                            echo "IMAGE_LATEST: ${IMAGE_LATEST}"
                            echo "BUILD_CONTEXT: ${WORKSPACE}/${BUILD_CONTEXT}"
                            echo ""
                            
                            echo "ğŸ—ï¸  Starting Kaniko build..."
                            /kaniko/executor \
                            --context ${WORKSPACE}/${BUILD_CONTEXT} \
                            --dockerfile ${WORKSPACE}/${DOCKERFILE_PATH} \
                            --destination ${IMAGE_NAME} \
                            --destination ${IMAGE_LATEST} \
                            --cache=true \
                            --cache-ttl=24h \
                            --compressed-caching=false \
                            --snapshot-mode=redo \
                            --verbosity=info \
                            --force
                            
                            echo "âœ… Build and push completed successfully!"
                            echo "ğŸ“¦ Tagged images:"
                            echo "   â€¢ ${IMAGE_NAME}"
                            echo "   â€¢ ${IMAGE_LATEST}"
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'âœ… PIPELINE SUCCESS'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo "ğŸ‰ Build completed successfully!"
                echo ""
                echo "ğŸ“¦ Image Information:"
                echo "   â€¢ Name: ${IMAGE_NAME}"
                echo "   â€¢ Latest: ${IMAGE_LATEST}"
                echo "   â€¢ Registry: ${ECR_REGISTRY}"
                echo "   â€¢ Repository: ${ECR_REPOSITORY}"
                echo ""
                echo "ğŸ¯ Target Environment:"
                echo "   â€¢ EKS Cluster: ${EKS_CLUSTER_NAME}"
                echo "   â€¢ Region: ${AWS_REGION}"
                echo "   â€¢ Namespace: ${K8S_NAMESPACE}"
                echo ""
                echo "ğŸ“Š Build Details:"
                echo "   â€¢ Build Number: ${BUILD_NUMBER}"
                echo "   â€¢ Image Tag: ${env.IMAGE_TAG}"
                echo "   â€¢ Git Commit: ${env.GIT_COMMIT_SHORT}"
                echo "   â€¢ Branch: ${env.GIT_BRANCH}"
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            }
        }
        
        failure {
            script {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'âŒ PIPELINE FAILED'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo "âš ï¸  Build failed at stage: ${env.STAGE_NAME}"
                echo ""
                echo "ğŸ“Š Build Information:"
                echo "   â€¢ Build Number: ${BUILD_NUMBER}"
                echo "   â€¢ Image Tag: ${env.IMAGE_TAG}"
                echo "   â€¢ Git Commit: ${env.GIT_COMMIT_SHORT}"
                echo "   â€¢ Branch: ${env.GIT_BRANCH}"
                echo ""
                echo "ğŸ’¡ Troubleshooting Steps:"
                echo "   1. Check the build logs above for errors"
                echo "   2. Verify AWS IAM permissions for ECR"
                echo "   3. Ensure Dockerfile exists in ${DOCKERFILE_PATH}"
                echo "   4. Verify build context directory: ${BUILD_CONTEXT}"
                echo "   5. Check network connectivity to ECR"
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            }
        }
        
        unstable {
            script {
                echo 'âš ï¸  Pipeline completed with warnings'
            }
        }
        
        always {
            script {
                echo ''
                echo 'ğŸ§¹ Cleanup Phase'
                echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
                echo 'âœ… Workspace cleanup completed'
                echo "â±ï¸  Total Duration: ${currentBuild.durationString}"
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            }
        }
    }
}
